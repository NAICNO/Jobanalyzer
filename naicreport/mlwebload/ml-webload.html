<!--

TODO:

Data
 - ml7 cpu data > 100% beginning of september, very very iffy; also a week mid-august
 - define what we're actually looking at (that is, what are the data plotted)
 - rmem data for ml7 is literally off the charts - what's the deal with that???  Reaches 115%.  This
   could just be that the memory is oversubscribed but I though we were measuring resident data?
   Observe the growth curve though: Goes up high, and then plummets.  Looks like a job that was killed.
 - same with rmem for ml8 going back a few days
 - weird artifact on ml2 - all data drop to zero for several hours - looks like the host stopped, somehow?
   or disk went away?  this could have been when the PAM authorization failed and cron could not run...

UX
 - show time along x axis somehow
 - show a legend somewhere about the meaning of data
 - probably want to draw a visible line at 100% to mark this, since the scale of the chart keeps changing
 - the rightmost point is frequently down at zero, this is not helpful, so what to do?  whose fault?  anyway
   we should not show this
 - handle files that don't exist (eg ml4 has no data in sonalyze output, hence no file produced)
   right now there's a fetch error but probably should have something better - either force the creation
   of the file, or throw up a message
 - tooltip could show user:job for top jobs, see more below

Functionality
 - is it useful to select absolute data rather than relative data?
 - see if jobgraph has anything to offer in terms of ideas
 - this is maybe a bridge too far, but it would be possible, for any point, to have a list of either
   the user names or command names or job numbers (or maybe username:job) that are the top consumers,
   usually there will be just a few.  that way, this dashboard serves the purpose of visualizing the
   cpu hogs.  not urgent.

-->

<html>
  <body onload="reload()">

    <select id=ml_node name="ML Node" onchange="reload()">
      <option value="ml1">ml1.hpc.uio.no</option>
      <option value="ml2">ml2.hpc.uio.no</option>
      <option value="ml3">ml3.hpc.uio.no</option>
      <option value="ml4">ml4.hpc.uio.no</option>
      <option value="ml6">ml6.hpc.uio.no</option>
      <option value="ml7">ml7.hpc.uio.no</option>
      <option value="ml8">ml8.hpc.uio.no</option>
    </select>

    <select id=frequency name="Frequency" onchange="reload()">
      <option value="daily">Daily, by hour</option>
      <option value="weekly">Weekly, by hour</option>
      <option value="monthly">Monthly, by day</option>
      <option value="quarterly">Quarterly, by day</option>
    </select>

    <div>
      <canvas id="ml_chart"></canvas>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
      var my_chart = null;

      function plotit(json_data, chart_name) {
	  const ctx = document.getElementById(chart_name);
	  let data = json_data.rcpu;
	  let rcpu_data = json_data.rcpu.map(d => d.y)	  
	  let rmem_data = json_data.rmem.map(d => d.y)
	  let rgpu_data = json_data.rgpu.map(d => d.y)
	  let rgpumem_data = json_data.rgpumem.map(d => d.y)
	  let maxval = Math.max(Math.max(...rcpu_data),
				Math.max(...rmem_data),
				Math.max(...rgpu_data),
				Math.max(...rgpumem_data),
			        100)
	  my_chart = new Chart(ctx, {
	      type: 'line',
	      data: {
		  labels: json_data.rcpu.map(d => d.x),
		  datasets: [
		      {
			  label: 'CPU%',
			  data: rcpu_data,
			  borderWidth: 2
		      },
		      {
			  label: 'RAM%',
			  data: rmem_data,
			  borderWidth: 2
		      },
		      {
			  label: 'GPU%',
			  data: rgpu_data,
			  borderWidth: 2
		      },
		      {
			  label: 'VRAM%',
			  data: rgpumem_data,
			  borderWidth: 2
		      },
		  ]
	      },
	      options: {
		  scales: {
		      x: {
			  beginAtZero: true,
		      },
		      y: {
			  beginAtZero: true,
			  max: Math.floor((maxval + 25) / 25) * 25,
		      }
		  }
	      }
	  })
      }

      function reload() {
	  if (my_chart != null)
	      my_chart.destroy()
	  let nodename = document.getElementById("ml_node").value
	  let frequency = document.getElementById("frequency").value
	  let filename = nodename + ".hpc.uio.no-" + frequency + ".json"
	  fetch("output/" + filename).then((response) => response.json()).then(data => plotit(data, 'ml_chart'))
      }
    </script>

  </body>
</html>
